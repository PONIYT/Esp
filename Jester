-- ESPModule.lua

local ESPModule = {}
ESPModule.__index = ESPModule

-- Default settings
local defaultSettings = {
    boxEnabled = true,
    tracerEnabled = true,
    espColor = Color3.fromRGB(255, 0, 0),
}

-- Create new ESP
function ESPModule.new()
    local self = setmetatable({}, ESPModule)
    
    -- Store settings and ESP components
    self.settings = defaultSettings
    self.espComponents = {}

    -- Setup ESP components
    self:createESPComponents()
    
    -- Update loop
    game:GetService("RunService").RenderStepped:Connect(function()
        self:updateESP()
    end)

    return self
end

-- Create ESP components for players
function ESPModule:createESPComponents()
    self.espComponents = {}
    for _, player in ipairs(game:GetService('Players'):GetPlayers()) do
        if player.Character then
            self.espComponents[player] = {
                Box = Drawing.new("Square"),
                Tracer = Drawing.new("Line"),
            }
            local components = self.espComponents[player]
            components.Box.Thickness = 1
            components.Box.Transparency = 1
            components.Box.Visible = false
            components.Box.Color = self.settings.espColor

            components.Tracer.Thickness = 1
            components.Tracer.Transparency = 1
            components.Tracer.Visible = false
            components.Tracer.Color = self.settings.espColor
        end
    end
end

-- Update ESP components
function ESPModule:updateESP()
    local camera = workspace.CurrentCamera

    for player, components in pairs(self.espComponents) do
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = player.Character.HumanoidRootPart
            local hrpPosition, onScreen = camera:WorldToViewportPoint(hrp.Position)
            local localPlayerPosition = camera:WorldToViewportPoint(camera.CFrame.p)

            if onScreen then
                local screenWidth, screenHeight = camera.ViewportSize.X, camera.ViewportSize.Y
                local factor = 1 / (hrpPosition.Z * math.tan(math.rad(camera.FieldOfView * 0.5)) * 2) * 100
                local width, height = math.floor(screenHeight / 25 * factor), math.floor(screenWidth / 27 * factor)

                -- Box properties
                if self.settings.boxEnabled then
                    components.Box.Size = Vector2.new(width, height)
                    components.Box.Position = Vector2.new(hrpPosition.X - width / 2, hrpPosition.Y - height / 2)
                    components.Box.Color = self.settings.espColor
                    components.Box.Visible = true
                else
                    components.Box.Visible = false
                end

                -- Tracer properties
                if self.settings.tracerEnabled then
                    components.Tracer.From = Vector2.new(localPlayerPosition.X, localPlayerPosition.Y)
                    components.Tracer.To = Vector2.new(hrpPosition.X, hrpPosition.Y + height / 2)
                    components.Tracer.Color = self.settings.espColor
                    components.Tracer.Visible = true
                else
                    components.Tracer.Visible = false
                end
            else
                components.Box.Visible = false
                components.Tracer.Visible = false
            end
        else
            components.Box.Visible = false
            components.Tracer.Visible = false
        end
    end
end

-- Set settings
function ESPModule:setSettings(newSettings)
    for key, value in pairs(newSettings) do
        if self.settings[key] ~= nil then
            self.settings[key] = value
        end
    end
end

-- Set color
function ESPModule:setColor(color)
    self.settings.espColor = color
    for _, components in pairs(self.espComponents) do
        if components.Box then
            components.Box.Color = color
        end
        if components.Tracer then
            components.Tracer.Color = color
        end
    end
end

return ESPModule
